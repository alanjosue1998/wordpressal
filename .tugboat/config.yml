services:
  php:
    image: tugboatqa/php:8.1-apache
    default: true
    depends: mysql
    commands:
      init:
        - apt-get update
        - apt-get install -y rsync libzip-dev libmagickwand-dev
        - a2enmod expires headers rewrite
        - docker-php-ext-install mysqli exif zip
        - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        - chmod +x wp-cli.phar
        - mv wp-cli.phar /usr/local/bin/wp
      update:
        # Configurar el directorio raíz del sitio WordPress
        - ln -snf "${TUGBOAT_ROOT}/web" "${DOCROOT}"
        - cp ${TUGBOAT_ROOT}/.tugboat/wp-config.tugboat.php ${DOCROOT}/wp-config.php
        - cp ${TUGBOAT_ROOT}/.tugboat/.htaccess ${DOCROOT}/.htaccess
        - mkdir -p "${DOCROOT}/wp-content/uploads" || /bin/true
        # Configurar permisos para uploads
        - chgrp -R www-data "${DOCROOT}/wp-content/uploads"
        - find "${DOCROOT}/wp-content/uploads" -type d -exec chmod 2775 {} \;
        - find "${DOCROOT}/wp-content/uploads" -type f -exec chmod 0664 {} \;
        # Limpiar archivos temporales
        - apt-get clean
        - rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
      build:
        # Comandos de construcción específicos para WordPress
        - wp cache flush || /bin/true
        - wp rewrite flush || /bin/true

  mysql:
    image: tugboatqa/mysql:8-debian
    commands:
      init: []
      update:
        # Aquí puedes agregar comandos para importar la base de datos si es necesario
        # - mysql -u tugboat -ptugboat tugboat < ${TUGBOAT_ROOT}/database.sql
      build: []
